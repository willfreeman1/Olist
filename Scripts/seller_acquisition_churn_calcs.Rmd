```{r}
# Calculate Seller Acquisition & Churn Estimates
```

```{r}
library(dplyr)
library(lubridate)

orders_items = merge(orders, order_items, by = "order_id")

orders_items_delivered <- orders_items %>%
  filter(order_status == "delivered")

# Convert orders_items to date and extract month
orders_items <- orders_items %>%
  mutate(
    order_purchase_timestamp = as.Date(order_purchase_timestamp),
    year_month = format(order_purchase_timestamp, "%Y-%m")
  )

# Create DF with monthly sales per seller
monthly_sales_per_seller <- orders_items %>%
  group_by(seller_id, year_month) %>%
  summarize(sales_count = n(), .groups = "drop")


monthly_sales_per_seller <- monthly_sales_per_seller %>%
  mutate(
    year_month = as.Date(paste0(year_month, "-01"))  # Append '-01' to convert to the first day of the month
  )

```

```{r}
# Calculate inactivity period after which a seller usually has no more sales, ie is unsubscribed or lost
library(dplyr)
library(lubridate)

# Revising the gap calculation to not prematurely filter, but rather calculate gaps broadly
seller_gaps <- monthly_sales_per_seller %>%
  arrange(seller_id, year_month) %>%
  group_by(seller_id) %>%
  mutate(
    next_sale_month = lead(year_month),
    gap = as.numeric(difftime(next_sale_month, year_month, units = "days")) / 30.44 # Approximating to months
  ) %>%
  ungroup()

# Now, focus on those gaps directly to analyze
# Here, we consider all gaps, then later focus on those leading to a final sale
gap_analysis <- seller_gaps %>%
  filter(!is.na(gap)) # Ensure we're considering all valid gaps

# Calculate the average and median gap length
typical_inactivity_period <- gap_analysis %>%
  summarise(
    average_gap = mean(gap, na.rm = TRUE),
    median_gap = median(gap, na.rm = TRUE)
  )

# Display the typical inactivity period
print(typical_inactivity_period)

```


```{r}
library(dplyr)
library(lubridate)
library(tidyr)

# Assuming monthly_sales_per_seller has been created as shown previously

# Determine the first and last sale month for each seller
seller_activity <- monthly_sales_per_seller %>%
  group_by(seller_id) %>%
  summarise(first_sale = min(year_month), last_sale = max(year_month)) %>%
  ungroup()

# Join this back to get new_sellers per month
monthly_new_sellers <- seller_activity %>%
  count(first_sale) %>%
  rename(month = first_sale, new_sellers = n)

# Calculate total active sellers per month directly from monthly_sales_per_seller
monthly_active_sellers <- monthly_sales_per_seller %>%
  count(year_month) %>%
  rename(month = year_month, total_active_sellers = n)

# For lost sellers, we'll assume calculation is done based on sellers not appearing after their last sale month
# This is a simplification and might need adjustment based on your definition of "lost"
monthly_lost_sellers <- seller_activity %>%
  count(last_sale) %>%
  rename(month = last_sale, lost_sellers = n)

# Combine the metrics into a single DataFrame
monthly_seller_stats <- monthly_new_sellers %>%
  full_join(monthly_active_sellers, by = "month") %>%
  full_join(monthly_lost_sellers, by = "month") %>%
  replace_na(list(new_sellers = 0, total_active_sellers = 0, lost_sellers = 0)) %>%
  arrange(month)

# Calculate cumulative sum of total_sellers_subscribed
monthly_seller_stats <- monthly_seller_stats %>%
  mutate(cumulative_new_sellers = cumsum(new_sellers),
         cumulative_lost_sellers = cumsum(lost_sellers),
         total_sellers_subscribed = cumulative_new_sellers - cumulative_lost_sellers) %>%
  select(-cumulative_new_sellers, -cumulative_lost_sellers)

# Calculate net subscriber change
# This is a placeholder; refine based on how you define net change
monthly_seller_stats <- monthly_seller_stats %>%
  mutate(net_subscriber_change = new_sellers - lost_sellers)

# Display the DataFrame
print(monthly_seller_stats)

```

```{r}
# Model number of lost sellers in Jul & Aug 2018 based on new sellers and total active sellers
library(dplyr)
library(lubridate)
library(ggplot2)

# Assuming 'monthly_seller_stats' is your DataFrame
# Ensure the 'month' column is in the correct date format
monthly_seller_stats$month <- as.Date(monthly_seller_stats$month)

# Use data from before July 2018 to train the model
training_data <- monthly_seller_stats %>%
  filter(month < as.Date("2018-07-01"))

# Linear regression model
model <- lm(lost_sellers ~ new_sellers + total_active_sellers, data = training_data)

# Summary of the model to inspect coefficients and model statistics
summary(model)

# For prediction, use actual data from Jan 2017 to Jun 2018
# We simulate prediction for July and August 2018 by using June 2018 data
june_2018_data <- monthly_seller_stats %>%
  filter(month == as.Date("2018-06-01")) %>%
  select(new_sellers, total_active_sellers)

# Predicting lost sellers for July and August 2018 based on June 2018 data
predicted_lost_sellers_jul_aug <- predict(model, newdata = june_2018_data)

predicted_lost_sellers_jul_aug


```

```{r}
# Replace Jul & Aug seller stats data with predictions
# Step 1: Filter out rows beyond August 2018 and erroneous rows
monthly_seller_stats <- monthly_seller_stats %>%
  filter(month <= as.Date("2018-08-01")) %>%
  filter(!is.na(month))

# Step 2: Correct total_sellers_subscribed for July and August 2018
# Assuming the 'total_sellers_subscribed' for June 2018 is correct, we adjust July and August based on net changes.
# Calculate net_subscriber_change for July and August 2018 based on the predicted lost_sellers
monthly_seller_stats <- monthly_seller_stats %>%
  mutate(
    net_subscriber_change = case_when(
      month == as.Date("2018-07-01") ~ new_sellers - predicted_lost_sellers,
      month == as.Date("2018-08-01") ~ new_sellers - predicted_lost_sellers,
      TRUE ~ net_subscriber_change
    )
  )

# Update total_sellers_subscribed based on net_subscriber_change cumulatively
monthly_seller_stats$total_sellers_subscribed <- cumsum(monthly_seller_stats$new_sellers) - cumsum(ifelse(is.na(monthly_seller_stats$lost_sellers), 0, monthly_seller_stats$lost_sellers))

# Display the updated DataFrame for verification
print(monthly_seller_stats)



```
```{r}
summary(monthly_seller_stats)
```


```{r}
library(ggplot2)

# Adjust start_date and end_date if needed
start_date <- as.Date("2017-01-01")
end_date <- as.Date("2018-07-31")

# Filter the dataframe to the specified date range
monthly_seller_stats_filtered <- monthly_seller_stats %>%
  filter(month >= start_date & month <= end_date)

ggplot(monthly_seller_stats_filtered, aes(x = month)) +
  geom_bar(aes(y = new_sellers, fill = "New Sellers"), stat = "identity") +
  geom_bar(aes(y = -lost_sellers, fill = "Churned Sellers"), stat = "identity") +
  geom_line(aes(y = net_subscriber_change, group = 1), color = "blue") +
  scale_fill_manual(values = c("New Sellers" = "green", "Churned Sellers" = "red")) +
  labs(title = "Monthly Seller Acquisition vs Churn (Jan 2017 - Jul 2018)",
       x = "Month",
       y = "Number of Sellers",
       fill = "Seller Type") +
  theme_minimal() +
  scale_y_continuous(labels = abs, sec.axis = sec_axis(~ ., name = "Net Subscriber Change"))

```

```{r}
saveRDS(monthly_seller_stats_filtered, "monthly_seller_stats_filtered.rds")
```


```{r}
# Show number of sellers subscribed
library(ggplot2)

start_date <- as.Date("2017-01-01")
end_date <- as.Date("2018-07-31")

# Filter the dataframe
monthly_seller_changes_filtered <- monthly_seller_changes %>%
  filter(month >= start_date & month <= end_date)

ggplot(monthly_seller_changes_filtered, aes(x = month)) +
  geom_bar(aes(y = new_sellers, fill = "New Sellers"), stat = "identity") +
  geom_bar(aes(y = -lost_sellers, fill = "Churned Sellers"), stat = "identity") +
  geom_line(aes(y = net_change, group = 1), color = "blue") +
  scale_fill_manual(values = c("New Sellers" = "green", "Churned Sellers" = "red")) +
  labs(title = "Monthly Seller Acquisition vs Churn (Jan 2017 - Jul 2018)",
       x = "Month",
       y = "Number of Sellers",
       fill = "Seller Type") +
  theme_minimal() +
  scale_y_continuous(labels = abs, sec.axis = sec_axis(~ ., name = "Net Change"))
```

```{r}
saveRDS(monthly_seller_changes_filtered, "seller_churn_df.rds")
```

